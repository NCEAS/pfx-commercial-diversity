---
title: 'Changes in diversity and variability in diversity through time: Catch portfolios
  paper 1A'
output:
  pdf_document:
    fig_caption: yes
  html_document: default
date: "April 7, 2016"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE)
```

## Load cleaned data  
```{r dataLoad, warning = FALSE, message=FALSE, results="hide", echo=FALSE}
library(dplyr)
library(knitr)
library(mgcv)
library(ggplot2)
library(randomForest)
library(MASS)
library(zoo)
library(MatchIt)
library(metafolio)
library(randomForest)
load("cfecCleaned2.Rdata")

# convert 6-dig p_fshy codes to 5 digits
# removing blank space - now they're all length(5)
idx = which(nchar(cfec$p_fshy)==6)
cfec$p_fshy[idx] = paste(substr(cfec$p_fshy[idx], 1, 1), 
  substr(cfec$p_fshy[idx], 3, 6), sep="")

# remove white space in 2nd position
idx = which(substr(cfec$p_fshy, 2, 2) == " ")
cfec$p_fshy[idx] = paste(substr(cfec$p_fshy[idx], 1, 1), 
  substr(cfec$p_fshy[idx], 3, length(cfec$p_fshy[idx])), sep="")

# Pull in "new.locs" from Anne/Jordan/Rich/Ben/Ole
newlocs = read.csv("new.locs.csv")
newlocs$p_fshy = as.character(newlocs$p_fshy)

# Match cfec codes in newlocs to identify new 
# locations (Anne/Jordan/Rich/Ben/Ole)
cfec$landedLoc = newlocs$New.Loc[match(cfec$p_fshy, newlocs$p_fshy)]
cfec$landedLoc[which(is.na(cfec$landedLoc))] = "Statewide" # C04B

```

We need to adjust the landed values and prices for inflation. To do this, we'll use the data Alan pulled together (adjusting to 2009 dollars). 

https://docs.google.com/spreadsheets/d/1hRLYTX1nZBLKnYXwTCOtU7-XnDoMZf_1ufdTiNQFd4U/edit#gid=0

```{r, echo=FALSE}
deflationTable = data.frame(year = 1985:2014, defl = c(0.57236, 0.58393, 0.59879, 0.61974,  
0.64388, 0.66774, 0.68993, 0.70564, 0.72244, 0.73781,  
0.75321, 0.76695, 0.78009, 0.78855, 0.80061,  
0.81883, 0.83753, 0.85038, 0.86729, 0.89114,  
0.91981, 0.94812, 0.97334, 0.9925, 1,  
1.01217, 1.03307, 1.05213, 1.06926, 1.08682))

# Adjust price and g_earn for inflation
cfec$year = as.numeric(cfec$year)
cfec$day = substr(cfec$landdate, 6, 10)
cfec$g_price = cfec$g_price/deflationTable$defl[cfec$year-1984]
cfec$g_earn = cfec$g_earn/deflationTable$defl[cfec$year-1984]
```

### Function definiton  
We need to define a few functions for calculating diversity. We'll use the Simpson's diversity index (HHI) to calculate the entropy-based inverse, which is a proxy for effective species diversity. Note the C++ version is commented out below,   
```{r, warning = FALSE, message=FALSE}

simp.div = function(x) {
  1/sum((x/sum(x))^2)
}

#library(Rcpp)
#cppFunction('double simpCpp(NumericVector x) {
#  double y = 1/sum((x/sum(x))^2);
#  return y;
#}')

# Note that the first line of this function uses group_by_ because 
# we need to pass in a string for 'variable'
effectiveDiversity_by_personYear = function(dataFrame, variable) {
  effDiv = group_by_(dataFrame, variable, "year", "p_holder") %>%
  summarize(totRev = sum(g_earn, na.rm=T),
  totN = n(),
  totWeight = sum(g_pounds, na.rm=T),
    days = length(unique(day))) %>% 
  as.data.frame() %>%
  filter(is.finite(totRev) & is.finite(totN) & is.finite(totWeight)) %>%   
  as.data.frame() %>%
  group_by(p_holder, year) %>% 
  summarize(eff.freq = simp.div(totN),
  eff.earn = simp.div(totRev),
  eff.lbs = simp.div(totWeight),
    totIndRev = sum(totRev),
    nCalDays = sum(days)) %>% 
  filter(!is.na(eff.freq) & !is.na(eff.earn) & !is.na(eff.lbs)) %>%
  as.data.frame()
  return(effDiv)
}

# Note that the first line of this function uses group_by_ because 
# we need to pass in a string for 'variable'
effectiveDiversity_by_personYear2 = function(dataFrame, variable1, variable2) {
  effDiv = group_by_(dataFrame, variable1, variable2, "year", "p_holder") %>%
  summarize(totRev = sum(g_earn, na.rm=T),
  totN = n(),
  totWeight = sum(g_pounds, na.rm=T),
    days = length(unique(day))) %>% 
  as.data.frame() %>%
  filter(is.finite(totRev) & is.finite(totN) & is.finite(totWeight)) %>%   
  as.data.frame() %>% 
  group_by_("p_holder", "year", variable2) %>% 
  summarize(eff.freq = simp.div(totN),
  eff.earn = simp.div(totRev),
  eff.lbs = simp.div(totWeight),
    totIndRev = sum(totRev),
    nCalDays = sum(days)) %>% 
  filter(!is.na(eff.freq) & !is.na(eff.earn) & !is.na(eff.lbs)) %>%
  as.data.frame()
  return(effDiv)
}

effectiveDiversity_by_Year = function(dataFrame, variable) {
  effDiv = group_by_(dataFrame, variable, "year") %>%
  summarize(totRev = sum(g_earn, na.rm=T),
  totN = n(),
  totWeight = sum(g_pounds, na.rm=T),
    days = length(unique(day))) %>% 
  as.data.frame() %>%
  filter(is.finite(totRev) & is.finite(totN) & is.finite(totWeight)) %>%   
  as.data.frame() %>%
  group_by(year) %>% 
  summarize(eff.freq = simp.div(totN),
  eff.earn = simp.div(totRev),
  eff.lbs = simp.div(totWeight),
    totIndRev = sum(totRev),
    nCalDays = sum(days)) %>% 
  filter(!is.na(eff.freq) & !is.na(eff.earn) & !is.na(eff.lbs)) %>%
  as.data.frame()
  return(effDiv)
}

# This function takes the output of the one above and 
# summmarizes diversity metrics
summarize_effectiveDiversity = function(dataFrame) {
  effDiv = group_by(dataFrame, year) %>% 
  summarize(mean.freq = mean(eff.freq),
  sd.freq = sd(eff.freq),
  mean.earn = mean(eff.earn),
  sd.earn = sd(eff.earn),
  mean.lbs = mean(eff.lbs),
  sd.lbs = sd(eff.lbs)) %>% 
  as.data.frame()  
  return(effDiv)
}


# This function takes the output of the one above and 
# summmarizes diversity metrics
summarize_effectiveDiversity2 = function(dataFrame, variable2) {
  effDiv = group_by_(dataFrame, "year", variable2) %>% 
  summarize(mean.freq = mean(eff.freq),
  sd.freq = sd(eff.freq),
  mean.earn = mean(eff.earn),
  sd.earn = sd(eff.earn),
  mean.lbs = mean(eff.lbs),
  sd.lbs = sd(eff.lbs)) %>% 
  as.data.frame()  
  return(effDiv)
}
```

## Diversity by species, gear, and fisheries. 

We have 4 dimensions we're interested in calculating diversity (species, gears, fisheries, space). And for each dimension, there's 3 ways we can calculate diversity: diversity based on fish ticket frequency, diversity based on revenue of each (weighted by g_earn) and diversity based on the weight of catch (g_pounds).  

To calculate the uncertainty (CV, quartiles, whatever) we need to calculate the diversity for each individual in each year (p_holder), and then summarize variability across individuals. We'll do this two ways: first using the whole dataset, and then using Eric's more restricted version (limiting the analysis to single people : vessel combinations)

### Calculations

We can calculate diversity across all metrics in the same block.
  
```{r}
cfec$permit_coarse = substr(cfec$p_fshy,1,1)
spDiv_personYear = effectiveDiversity_by_personYear(cfec, variable="specn")
spTot = summarize_effectiveDiversity( spDiv_personYear )

gearDiv_personYear = effectiveDiversity_by_personYear(cfec, variable="gearn")
gearTot = summarize_effectiveDiversity( gearDiv_personYear )

fishDiv_personYear = effectiveDiversity_by_personYear(cfec, variable="permit_coarse")
fishTot = summarize_effectiveDiversity( fishDiv_personYear )

areaDiv_personYear = effectiveDiversity_by_personYear(cfec, variable="area")
areaTot = summarize_effectiveDiversity( areaDiv_personYear )
```

### Summarizing landings and value

First, it's helpful to identify the broad patterns in the CFEC data, showing time series of people, landings, and revenue by year. The general patterns are consistent with Kasperski & Holland's analysis that showed diversity declining. More specificially,  

- Total participation decreased after ~ 1990, both in terms of people + boats  
- Participation has been flat since early 2000s, but since 2000
- both catch (lbs landed) / person, and revenue / person have been increasing  

```{r}
cfecSummarize = group_by(cfec, year) %>%
  summarize(people = length(unique(p_holder)), 
    revenue = sum(g_earn), catch = sum(g_pounds),
    vessels = length(unique(cadfg))) %>%
  as.data.frame
par(mfrow = c(3,2), mgp=c(2,1,0), mai=c(0.5,0.5,0.05,0.05))
plot(cfecSummarize$year, cfecSummarize$people/1000, xlab="", ylab="People (1000s)", type="b", lwd=3)
plot(cfecSummarize$year, cfecSummarize$revenue/1e+09, xlab="", ylab="Billion $s", type="b", lwd=3)
plot(cfecSummarize$year, cfecSummarize$catch/2e+06, xlab="", ylab="Weight (tons)", type="b", lwd=3)
plot(cfecSummarize$year, cfecSummarize$revenue/cfecSummarize$people, xlab="", ylab="$s / person", type="b", lwd=3)
plot(cfecSummarize$year, cfecSummarize$catch/cfecSummarize$people, xlab="", ylab="Lbs / person", type="b", lwd=3)
plot(cfecSummarize$year, cfecSummarize$vessels/cfecSummarize$people, xlab="", ylab="Boats / person", type="b", lwd=3)

```

### Patterns in diversity metrics

We can coarsely group individuals based on their species, gear, and fisheries diversity through time (e.g. 1-1.5, 1.5-2, 2-2.5, etc.) and make boxplots of revenue by group over time (similar to Jordan's boxplots). 
```{r}
brks = c(1, 1.0001, 1.5, 2, 2.5, 3, 3.5, 4, 10)

spDiv_personYear$group = cut(spDiv_personYear$eff.earn, breaks = brks, right=FALSE)
gearDiv_personYear$group = cut(gearDiv_personYear$eff.earn, breaks = brks, right=FALSE)
fishDiv_personYear$group = cut(fishDiv_personYear$eff.earn, breaks = brks, right=FALSE)
areaDiv_personYear$group = cut(areaDiv_personYear$eff.earn, breaks = brks, right=FALSE)
```

We can start by just plotting changes in group membership over time. The interesting patterns here are:
1. Species: If we lump the lowest diversity groups (1 - 1.5 spp), there's been a slight uptick from ~ 55% - 65% (consistent with specialization).  
2. Gears / Permits: people fishing 1 gear or 1 permit have also increased since ~ 1991, from ~ 70% to > 80% of all records.  
3. There's no interesting trend with respect to regions; 75-80% of the people fish 1 region, and there's no trend. [Revisit after getting Anne's areas]

```{r, fig.pos="placeHere", fig.cap="Proportion of people by species diversity groups"}
group.sum = group_by(spDiv_personYear, year, group) %>% 
  summarize(n = length(unique(p_holder))) %>% 
  as.data.frame()
tot = group_by(group.sum, year) %>% 
  summarize(tot = sum(n))
group.sum.spec = left_join(group.sum, tot)
ggplot(group.sum.spec, aes(x=year, y=n/tot, group=group, colour=group ) ) + geom_line() +
  ggtitle("P_holder by species diversity groups") + 
xlab("Year") + ylab("Percent of total") 
```

```{r, fig.pos="placeHere", fig.cap="Proportion of people by gear diversity groups"}
group.sum = group_by(gearDiv_personYear, year, group) %>% 
  summarize(n = length(unique(p_holder))) %>% 
  as.data.frame()
tot = group_by(group.sum, year) %>% 
  summarize(tot = sum(n))
group.sum.gear = left_join(group.sum, tot)
ggplot(group.sum.gear, aes(x=year, y=n/tot, group=group, colour=group ) ) + geom_line() +
  ggtitle("P_holder by gear diversity groups") + 
xlab("Year") + ylab("Percent of total") 
```

```{r, fig.pos="placeHere", fig.cap="Proportion of people by area diversity groups"}
group.sum = group_by(areaDiv_personYear, year, group) %>% 
  summarize(n = length(unique(p_holder))) %>% 
  as.data.frame()
tot = group_by(group.sum, year) %>% 
  summarize(tot = sum(n))
group.sum.area = left_join(group.sum, tot)
ggplot(group.sum.area, aes(x=year, y=n/tot, group=group, colour=group ) ) + geom_line() +
  ggtitle("P_holder by area diversity groups") + 
xlab("Year") + ylab("Percent of total") 
```

```{r, fig.pos="placeHere", fig.cap="Proportion of people by permit diversity groups"}
group.sum = group_by(fishDiv_personYear, year, group) %>% 
  summarize(n = length(unique(p_holder))) %>% 
  as.data.frame()
tot = group_by(group.sum, year) %>% 
  summarize(tot = sum(n))
group.sum.fish = left_join(group.sum, tot)
ggplot(group.sum.fish, aes(x=year, y=n/tot, group=group, colour=group ) ) + geom_line() +
  ggtitle("P_holder by permit diversity groups") + 
xlab("Year") + ylab("Percent of total") 
```

It's pretty easy as a next step to focus on specialists (gears, permits). Which gears and permits are being used, and how does this break down by area? This shows some pretty interesting patterns that we can characterize about 'specialists':

- longline specialists greatly decreased after 2004 (going to 0 in alaska peninsula, cook inlet, huge drops in kodiak, smaller drops in PWS / Southeast).  
- we've seen slight increases in drift gillnet specialists (gearn = 3) in Bristol Bay, and larger increases in PWS / Cook Inlet (presumably copper river sockeye)  

```{r}
# Find all people in group 1 (specialists)
sub = gearDiv_personYear[which(as.numeric(gearDiv_personYear$group)%in%c(1,2)),]
LJ = left_join(sub, cfec)
# Calculate number of people using each gear type
LJ = group_by(LJ, gearn, year, landedLoc) %>% 
  summarize(n = length(unique(p_holder)))
# Calculate total to normalize to %
tot = group_by(LJ, year, landedLoc) %>% 
  summarize(tot = sum(n))
LJ = left_join(LJ, tot)
# Plot proportions
ggplot(LJ, aes(x=year, y=n/tot, group=as.factor(gearn), colour=as.factor(gearn) ) ) + geom_line() + facet_wrap(~ landedLoc, scales="free_y") + ylab("Proportion of people")
```

The next is to pull out the specialists, by gear or species. For example we can pull out people specializing on salmon. For example, we could look at the trends in some of these metrics for people who are only using a gear specific to salmon (1, 3, 4). There's a few interesting things here:  

-- Nobody uses > 2 gears 

```{r}
salmonSpecialists = group_by(cfec, year, p_holder, landedLoc) %>% 
  summarize(gears = length(unique(gearn)), 
    salmonGears = length(unique(gearn%in%c(1,3,4))),
    salmonSpec = length(unique(specn[specn%in%c(410,420,430,440,450)]))) %>% 
  filter(salmonGears == gears & salmonSpec >= 1) 

salmonSummary = group_by(salmonSpecialists, year, landedLoc) %>% 
  summarize(ngear = mean(gears), ngear2 = length(which(gears == 2)), npeople = length(unique(p_holder)), nspec = mean(salmonSpec)) %>% 
  filter(landedLoc %in% c("Bering Sea", "Aleutian Islands", "Dutch Harbor", "Statewide", "GOA", "EEZ")==FALSE)

ggplot(salmonSummary, aes(x=year, y=ngear2/npeople) ) + geom_line() + facet_wrap(~ landedLoc, scales="free_y") + ylab("% People using 2 salmon gears")

ggplot(salmonSummary, aes(x=year, y=npeople) ) + geom_line() + facet_wrap(~ landedLoc, scales="free_y") + ylab("People exclusively using gears 1,3,4")

ggplot(salmonSummary, aes(x=year, y=nspec) ) + geom_line() + facet_wrap(~ landedLoc, scales="free_y") + ylab("People exclusively using gears 1,3,4")

salmonSpecialists = group_by(cfec, year, p_holder) %>% 
  summarize(gears = length(unique(gearn)), 
    salmonGears = length(unique(gearn%in%c(1,3,4))),
    salmonSpec = length(unique(specn[specn%in%c(410,420,430,440,450)]))) %>% 
  filter(salmonGears == gears & salmonSpec >= 1) 
salmonSpecialists = left_join(salmonSpecialists, cfec)
```

```{r, fig.pos="placeHere", fig.cap="Revenue by effective species diversity and year", echo=FALSE}
ggplot(spDiv_personYear, aes(x = factor(year), y = log10(totIndRev), fill = factor(group))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by species diversity ('specn') and year") + 
xlab("Year") + ylab("log10(revenue)")
```

We can also try to calculate downside risk, by group. We'll start with the lower 95% for each group. 
```{r, fig.pos="placeHere", fig.cap="Downside risk metrics: lower 5% and 20% of total revenue, by species diversity and year", echo=FALSE}
spDiv_lower = group_by(spDiv_personYear, year, group) %>% 
  summarize(lower95 = quantile(log10(totIndRev),0.05),
    lower80 = quantile(log10(totIndRev),0.2))
ggplot(spDiv_lower, aes(x=year, y=lower95, group=group, colour=group ) ) + 
            geom_line(size=1) + geom_line(aes(x=year, y=lower80, group=group, colour=group ), size=1, linetype = 2) +
  ggtitle("Lower 5% (solid) of and 20% (dashed) log10(revenue)") + 
xlab("Year") + ylab("Lower 5% and 20%")  
```

```{r, fig.pos="placeHere", fig.cap="Revenue by effective species diversity across years", echo=FALSE}
ggplot(spDiv_personYear, aes(x = factor(group), y = log10(totIndRev))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by species diversity ('specn')") + 
xlab("Effective diversity") + ylab("log10(revenue)")
```

```{r, fig.pos="placeHere", fig.cap="Number of unique landed dates by effective species diversity across years", echo=FALSE, include=FALSE}
ggplot(spDiv_personYear, aes(x = factor(group), y = log(nCalDays))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Unique landed dates by species diversity ('specn')") + 
xlab("Effective diversity") + ylab("log(unique days)")
```

```{r, fig.pos="placeHere", fig.cap="Revenue by effective gear diversity and year", echo=FALSE}
ggplot(gearDiv_personYear, aes(x = factor(year), y = log10(totIndRev), fill = factor(group))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by gear diversity ('gearn') and year") + 
xlab("Year") + ylab("log10(revenue)")
```

```{r, fig.pos="placeHere", fig.cap="Downside risk metrics: lower 5% and 20% of total revenue, by gear diversity and year", echo=FALSE, include=FALSE}
gearDiv_lower = group_by(gearDiv_personYear, year, group) %>% 
  summarize(lower95 = quantile(log10(totIndRev),0.05),
    lower80 = quantile(log10(totIndRev),0.2))
ggplot(gearDiv_lower, aes(x=year, y=lower95, group=group, colour=group ) ) + 
            geom_line(size=1) + geom_line(aes(x=year, y=lower80, group=group, colour=group ), size=1, linetype = 2) +
  ggtitle("Lower 5% (solid) of and 20% (dashed) log10(revenue)") + 
xlab("Year") + ylab("Lower 5% and 20%")  
```

```{r, fig.pos="placeHere", fig.cap="Revenue by effective gear diversity across years", echo=FALSE, include=FALSE}
ggplot(gearDiv_personYear, aes(x = factor(group), y = log10(totIndRev))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by gear diversity ('gearn')") + 
xlab("Effective diversity") + ylab("log10(revenue)")
```

```{r, fig.pos="placeHere", fig.cap="Number of unique landed dates by effective gear diversity across years", echo=FALSE, include=FALSE}
ggplot(gearDiv_personYear, aes(x = factor(group), y = log(nCalDays))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Unique landed dates by gear diversity ('gearn')") + 
xlab("Effective diversity") + ylab("log(unique days)")
```

```{r, fig.pos="placeHere", fig.cap="Revenue by effective permit diversity and year", echo=FALSE}
ggplot(fishDiv_personYear, aes(x = factor(year), y = log10(totIndRev), fill = factor(group))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by permit diversity ('p_fshy') and year") + 
xlab("Year") + ylab("log10(revenue)")
```

```{r, fig.pos="placeHere", fig.cap="Downside risk metrics: lower 5% and 20% of total revenue, by permit diversity and year", echo=FALSE, include=FALSE}
fishDiv_lower = group_by(fishDiv_personYear, year, group) %>% 
  summarize(lower95 = quantile(log10(totIndRev),0.05),
    lower80 = quantile(log10(totIndRev),0.2))
ggplot(fishDiv_lower, aes(x=year, y=lower95, group=group, colour=group ) ) + 
            geom_line(size=1) + geom_line(aes(x=year, y=lower80, group=group, colour=group ), size=1, linetype = 2) +
  ggtitle("Lower 5% (solid) of and 20% (dashed) log10(revenue)") + 
xlab("Year") + ylab("Lower 5% and 20%")  
```

```{r, fig.pos="placeHere", fig.cap="Revenue by effective permit diversity across years", echo=FALSE, include=FALSE}
ggplot(fishDiv_personYear, aes(x = factor(group), y = log10(totIndRev))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by permit diversity ('p_fshy')") + 
xlab("Effective diversity") + ylab("log10(revenue)")
```

```{r, fig.pos="placeHere", fig.cap="Number of unique landed dates by effective permit diversity across years", echo=FALSE, include=FALSE}
ggplot(fishDiv_personYear, aes(x = factor(group), y = log(nCalDays))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Unique landed dates by permit diversity ('p_fshy')") + 
xlab("Effective diversity") + ylab("log(unique days)")
```


```{r, fig.pos="placeHere", fig.cap="Revenue by effective area diversity and year", echo=FALSE}
ggplot(areaDiv_personYear, aes(x = factor(year), y = log10(totIndRev), fill = factor(group))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by area diversity ('landedLoc') and year") + 
xlab("Year") + ylab("log10(revenue)")
```

```{r, fig.pos="placeHere", fig.cap="Revenue by area permit diversity across years", include=FALSE, echo=FALSE}
ggplot(areaDiv_personYear, aes(x = factor(group), y = log10(totIndRev))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Revenue by area diversity ('landedLoc')") + 
xlab("Effective diversity") + ylab("log10(revenue)")
```

```{r, fig.pos="placeHere", fig.cap="Number of unique landed dates by area permit diversity across years", echo=FALSE, include=FALSE}
ggplot(fishDiv_personYear, aes(x = factor(group), y = log(nCalDays))) + 
  geom_boxplot(outlier.shape=NA) + 
  ggtitle("Unique landed dates by area diversity ('landedLoc')") + 
xlab("Effective diversity") + ylab("log(unique days)")
```

### Species  

```{r, fig.pos="placeHere", fig.cap="Species diversity (all individuals/vessels). For scaling purposes, 1.2 is subtracted from the diversity based on fish ticket frequency.", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(spTot, aes(x=year, y=mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=mean.lbs), col="red") + 
geom_line(aes(x=year,y=mean.freq-1.2), col="blue") + 
ggtitle("Effective species diversity ('specn') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV of Species diversity (all individuals/vessels)", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(spTot, aes(x=year, y=sd.earn/mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
geom_line(aes(x=year,y=sd.freq/mean.freq), col="blue") + 
ggtitle("CV of species diversity ('specn') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("CV")
```
 
### Gears 

```{r, fig.pos="placeHere", fig.cap="Gear diversity (all individuals/vessels)", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(gearTot, aes(x=year, y=mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=mean.lbs), col="red") + 
geom_line(aes(x=year,y=mean.freq), col="blue") + 
ggtitle("Effective gear diversity ('gearn') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV of gear diversity (all individuals/vessels)", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(gearTot, aes(x=year, y=sd.earn/mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
geom_line(aes(x=year,y=sd.freq/mean.freq), col="blue") + 
ggtitle("CV of gear diversity ('gearn') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("CV")
```

### Fisheries 

```{r, fig.pos="placeHere", fig.cap="Permit diversity (all individuals/vessels)", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(fishTot, aes(x=year, y=mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=mean.lbs), col="red") + 
geom_line(aes(x=year,y=mean.freq), col="blue") + 
ggtitle("Effective permit diversity ('p_fshy') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV of permit diversity (all individuals/vessels)", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(fishTot, aes(x=year, y=sd.earn/mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
geom_line(aes(x=year,y=sd.freq/mean.freq), col="blue") + 
ggtitle("CV of permit diversity ('p_fshy') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("CV")
```

### Areas (including EEZ / Statewide / GOA categories)

```{r, fig.pos="placeHere", fig.cap="Area diversity (all individuals/vessels)", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(areaTot, aes(x=year, y=mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=mean.lbs), col="red") + 
geom_line(aes(x=year,y=mean.freq), col="blue") + 
ggtitle("Effective area diversity ('p_fshy') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV of area diversity (all individuals/vessels)", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(areaTot, aes(x=year, y=sd.earn/mean.earn)) + geom_line(col="green") + 
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
geom_line(aes(x=year,y=sd.freq/mean.freq), col="blue") + 
ggtitle("CV of area diversity ('landedLoc') [green='$', red=weight, blue = %]") + 
xlab("Year") + ylab("CV")
```

## Finer scale exploration of patterns

We can also look further into whether the observed trends in mean and CV of revenue vary by gear type, area, permit type, etc. 

```{r, fig.pos="placeHere", fig.cap="Mean species diversity, split by gear type (weighted by catch and revenue).", echo=FALSE}
spDiv_personYear2 = effectiveDiversity_by_personYear2(cfec, variable1="specn", variable2 = "gearn")
spTot2 = summarize_effectiveDiversity2( spDiv_personYear2, variable2 = "gearn" )

# Use gear as the facet here
ggplot(spTot2, aes(year, mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=mean.lbs), col="red") + 
facet_wrap(~ gearn, scales="free_y") + 
ggtitle("Species diversity ('specn') [green='$', red=weight]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV species diversity, split by gear type (weighted by catch and revenue).", echo=FALSE}

# Use gear as the facet here
ggplot(spTot2, aes(year, sd.earn/mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
facet_wrap(~ gearn, scales="free_y") + 
ggtitle("CV of species diversity ('specn') [green='$', red=weight]") + 
xlab("Year") + ylab("CV of effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="Mean species diversity, split by location (weighted by catch and revenue).", echo=FALSE}
spDiv_personYear2 = effectiveDiversity_by_personYear2(cfec, variable1="specn", variable2 = "landedLoc")
spTot2 = summarize_effectiveDiversity2( spDiv_personYear2, variable2 = "landedLoc" )

# Use landedLoc as the facet here
ggplot(spTot2, aes(year, mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=mean.lbs), col="red") + 
facet_wrap(~ landedLoc, scales="free_y") + 
ggtitle("Species diversity ('specn') [green='$', red=weight]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV species diversity, split by location (weighted by catch and revenue).", echo=FALSE}

# Use gear as the facet here
ggplot(spTot2, aes(year, sd.earn/mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
facet_wrap(~ landedLoc, scales="free_y") + 
ggtitle("CV of species diversity ('specn') [green='$', red=weight]") + 
xlab("Year") + ylab("CV of effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="Mean species diversity, split by fishery (weighted by catch and revenue).", echo=FALSE}
cfec$permit_coarse = substr(cfec$p_fshy,1,1)
spDiv_personYear2 = effectiveDiversity_by_personYear2(cfec, variable1="specn", variable2 = "permit_coarse")
spTot2 = summarize_effectiveDiversity2( spDiv_personYear2, variable2 = "permit_coarse" )

# Use landedLoc as the facet here
ggplot(spTot2, aes(year, mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=mean.lbs), col="red") + 
facet_wrap(~ permit_coarse, scales="free_y") + 
ggtitle("Species diversity ('specn') [green='$', red=weight]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV species diversity, split by fishery (weighted by catch and revenue).", echo=FALSE}
# Use gear as the facet here
ggplot(spTot2, aes(year, sd.earn/mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
facet_wrap(~ permit_coarse, scales="free_y") + 
ggtitle("CV of species diversity ('specn') [green='$', red=weight]") + 
xlab("Year") + ylab("CV of effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="Mean gear diversity, split by area (weighted by catch and revenue).", echo=FALSE}
cfec$permit_coarse = substr(cfec$p_fshy,1,1)
spDiv_personYear2 = effectiveDiversity_by_personYear2(cfec, variable1="gearn", variable2 = "landedLoc")
spTot2 = summarize_effectiveDiversity2( spDiv_personYear2, variable2 = "landedLoc" )

# Use landedLoc as the facet here
ggplot(spTot2, aes(year, mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=mean.lbs), col="red") + 
facet_wrap(~ landedLoc, scales="free_y") + 
ggtitle("Gear diversity ('gearn') [green='$', red=weight]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV species diversity, split by fishery (weighted by catch and revenue).", echo=FALSE}
# Use gear as the facet here
ggplot(spTot2, aes(year, sd.earn/mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
facet_wrap(~ landedLoc, scales="free_y") + 
ggtitle("CV of gear diversity ('gearn') [green='$', red=weight]") + 
xlab("Year") + ylab("CV of effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="Mean permit diversity, split by area (weighted by catch and revenue).", echo=FALSE}
spDiv_personYear2 = effectiveDiversity_by_personYear2(cfec, variable1="p_fshy", variable2 = "landedLoc")
spTot2 = summarize_effectiveDiversity2( spDiv_personYear2, variable2 = "landedLoc" )

# Use landedLoc as the facet here
ggplot(spTot2, aes(year, mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=mean.lbs), col="red") + 
facet_wrap(~ landedLoc, scales="free_y") + 
ggtitle("Permit diversity ('p_fshy') [green='$', red=weight]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV permit diversity, split by fishery (weighted by catch and revenue).", echo=FALSE}
# Use gear as the facet here
ggplot(spTot2, aes(year, sd.earn/mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
facet_wrap(~ landedLoc, scales="free_y") + 
ggtitle("CV of permit diversity ('p_fshy') [green='$', red=weight]") + 
xlab("Year") + ylab("CV of effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="Mean gear diversity, split by permits (weighted by catch and revenue).", echo=FALSE}
spDiv_personYear2 = effectiveDiversity_by_personYear2(cfec, variable1="gearn", variable2 = "permit_coarse")
spTot2 = summarize_effectiveDiversity2( spDiv_personYear2, variable2 = "permit_coarse" )

# Use landedLoc as the facet here
ggplot(spTot2, aes(year, mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=mean.lbs), col="red") + 
facet_wrap(~ permit_coarse, scales="free_y") + 
ggtitle("Permit gear diversity ('gearn') [green='$', red=weight]") + 
xlab("Year") + ylab("Effective diversity")
```

```{r, fig.pos="placeHere", fig.cap="CV gear diversity, split by permit (weighted by catch and revenue).", echo=FALSE}
# Use gear as the facet here
ggplot(spTot2, aes(year, sd.earn/mean.earn)) + geom_line(col="green") +
geom_line(aes(x=year,y=sd.lbs/mean.lbs), col="red") + 
facet_wrap(~ permit_coarse, scales="free_y") + 
ggtitle("CV of gear diversity ('p_fshy') [green='$', red=weight]") + 
xlab("Year") + ylab("CV of effective diversity")
```

## Filtering of unique people:vessel combinations

Filter out people who only use 1 vessel / year , and similarly filter out boats with more than 1 person / year. Some people might fish on multiple vessels within a year, and vessels might be used by multiple people within a year.  

Now we'll filter out individuals who only used 1 boat in a year, and boats with only one permit holder fishing in a year.  
```{r}
cfecnew = cfec
cfec.1boat = group_by(cfecnew, p_holder, year) %>% 
  summarize(nBoat = length(unique(cadfg))) %>%
  filter(nBoat==1) %>% 
  left_join(cfecnew)

# Deal with setnet fisheries, where lots of p_holder
# share same codes
cfec.1boat = group_by(cfec.1boat, cadfg, year) %>% 
  summarize(nPerson = length(unique(p_holder))) %>%
  filter((nPerson==1 & cadfg %in% c(27960,27961) == FALSE) | cadfg %in% c(27960,27961)) %>% 
  left_join(cfec.1boat)

cfecnew = cfec.1boat
dim(cfecnew)[1]

#Now we can create a unique *id* column for individual - vessel combinations.  
cfecnew$id = paste(cfecnew$p_holder,cfecnew$cadfg)
# calculate number of unique person - vessel pairs ~ 40700
length(unique(cfecnew$id))
```
### Re-calculating diversity


```{r}
spDiv_personYear = effectiveDiversity_by_personYear(cfecnew, variable="specn")
spTot = summarize_effectiveDiversity( spDiv_personYear )

gearDiv_personYear = effectiveDiversity_by_personYear(cfecnew, variable="gearn")
gearTot = summarize_effectiveDiversity( gearDiv_personYear )

fishDiv_personYear = effectiveDiversity_by_personYear(cfecnew, variable="p_fshy")
fishTot = summarize_effectiveDiversity( fishDiv_personYear )
```

### Species  

```{r, fig.pos = "placeHere", fig.cap = "Species diversity by frequency of fish tickets of unique id:vessel combinations (excluding people who fish multiple vessels / year, or vessels that are fished by multiple individuals in a year.", echo=FALSE}

ggplot(spTot, aes(x=year, y=mean.freq)) + geom_line(col="blue") +
  geom_ribbon(aes(ymin=mean.freq - sd.freq/mean.freq, 
  ymax=mean.freq + sd.freq/mean.freq), alpha=0.2, fill="blue") + 
ggtitle("Effective species diversity ('specn') by fishTix") + 
xlab("Year") + ylab("Mean (+/- CV)")
```

```{r, fig.pos = "placeHere", fig.cap = "Species diversity by revenue and landed weight of unique id:vessel combinations (excluding people who fish multiple vessels / year, or vessels that are fished by multiple individuals in a year.", echo=FALSE}

# Plot by earning / weight on diff scale
ggplot(spTot, aes(x=year, y=mean.earn)) + geom_line(col="red") + 
geom_ribbon(aes(x = year, ymin=mean.earn - sd.earn/mean.earn, 
  ymax = mean.earn + sd.earn/mean.earn), alpha=0.2, fill="red") + 
geom_line(aes(x=year,y=mean.lbs), col="green") + 
geom_ribbon(aes(x = year, ymin=mean.lbs - sd.lbs/mean.lbs, 
  ymax=mean.lbs + sd.lbs/mean.lbs), alpha=0.2, fill="green") +
ggtitle("Effective species diversity ('specn') [red = $, green=weight]") + 
xlab("Year") + ylab("Mean (+/- CV)")
```
 
### Gears 
  
```{r, fig.pos = "placeHere", fig.cap = "Gear diversity by fish tickets of unique id:vessel combinations (excluding people who fish multiple vessels / year, or vessels that are fished by multiple individuals in a year.", echo=FALSE}
ggplot(gearTot, aes(x=year, y=mean.freq)) + geom_line(col="blue") + 
geom_ribbon(aes(ymin=mean.freq - sd.freq/mean.freq, 
  ymax=mean.freq + sd.freq/mean.freq), alpha=0.2, fill="blue") + 
ggtitle("Effective gear diversity ('gearn') by fishTix") + 
xlab("Year") + ylab("Mean (+/- CV)")
```

```{r, fig.pos = "placeHere", fig.cap = "Gear diversity by revenue and landed weight of unique id:vessel combinations (excluding people who fish multiple vessels / year, or vessels that are fished by multiple individuals in a year.", echo=FALSE}
# Plot by earning / weight on diff scale
ggplot(gearTot, aes(x=year, y=mean.earn)) + geom_line(col="red") + 
geom_ribbon(aes(x = year, ymin=mean.earn - sd.earn/mean.earn, 
  ymax = mean.earn + sd.earn/mean.earn), alpha=0.2, fill="red") + 
geom_line(aes(x=year,y=mean.lbs), col="green") + 
geom_ribbon(aes(x = year, ymin=mean.lbs - sd.lbs/mean.lbs, 
  ymax=mean.lbs + sd.lbs/mean.lbs), alpha=0.2, fill="green") + 
ggtitle("Effective gear diversity ('gearn') [red = $, green=weight]") + 
xlab("Year") + ylab("Mean (+/- CV)")
```

### Fisheries 
```{r, fig.pos = "placeHere", fig.cap = "Permit diversity by fish ticket frequency of unique id:vessel combinations (excluding people who fish multiple vessels / year, or vessels that are fished by multiple individuals in a year.", echo=FALSE}

ggplot(fishTot, aes(x=year, y=mean.freq)) + geom_line(col="blue") +
geom_ribbon(aes(ymin=mean.freq - sd.freq/mean.freq, 
  ymax=mean.freq + sd.freq/mean.freq), alpha=0.2, fill="blue") + 
ggtitle("Effective permit diversity ('p_fshy') by fishTix") + 
xlab("Year") + ylab("Mean (+/- CV)")
```

```{r, fig.pos = "placeHere", fig.cap = "Permit diversity by revenue and landed weight of unique id:vessel combinations (excluding people who fish multiple vessels / year, or vessels that are fished by multiple individuals in a year.", echo=FALSE}

# Plot by earning / weight on diff scale
ggplot(fishTot, aes(x=year, y=mean.earn)) + geom_line(col="red") + 
geom_ribbon(aes(x = year, ymin=mean.earn - sd.earn/mean.earn, 
  ymax = mean.earn + sd.earn/mean.earn), alpha=0.2, fill="red") + 
geom_line(aes(x=year,y=mean.lbs), col="green") + 
geom_ribbon(aes(x = year, ymin=mean.lbs - sd.lbs/mean.lbs, 
  ymax=mean.lbs + sd.lbs/mean.lbs), alpha=0.2, fill="green") + 
ggtitle("Effective permit diversity ('p_fshy') [red = $, green=weight]") + 
xlab("Year") + ylab("Mean (+/- CV)")
```

## Comparing diversity between vessels and individuals

Just out of curiousity, we can summarize diversity by year taking the approach used by Kasperski and Holland (based on CADFG number) and compare that to the same criteria using people ("p_holder"). We'll only do this comparison on the species diversity, but use the same restriction: use only vessels or people who had participated continuously for the entire time period (this throws out 90%+ of the data). 

First, based on vessels:
```{r}
contVessels = group_by(cfec, cadfg) %>% 
  summarize(nYear = length(unique(year))) %>% 
  filter(nYear == 30)

cfecnew = left_join(contVessels, cfec)

# calculate diversity by species by CADFG (vessel #)
effDiv.vessel = group_by(cfecnew, specn, year, cadfg) %>%
  summarize(totRev = sum(g_earn, na.rm=T),
  totN = n(),
  totWeight = sum(g_pounds, na.rm=T),
    days = length(unique(day))) %>% 
  as.data.frame() %>%
  filter(is.finite(totRev) & is.finite(totN) & is.finite(totWeight)) %>%   
  as.data.frame() %>%
  group_by(cadfg, year) %>% 
  summarize(eff.freq = simp.div(totN),
  eff.earn = simp.div(totRev),
  eff.lbs = simp.div(totWeight),
    totIndRev = sum(totRev),
    nCalDays = sum(days)) %>% 
  filter(!is.na(eff.freq) & !is.na(eff.earn) & !is.na(eff.lbs)) %>%
  as.data.frame()

effDiv.vessel = summarize_effectiveDiversity(effDiv.vessel)

effDiv.person = effectiveDiversity_by_personYear(cfecnew, variable="specn")
effDiv.person = summarize_effectiveDiversity( effDiv.person )
```

```{r, fig.pos="placeHere", fig.cap="Comparison of species diversity using vessel versus individuals", echo=FALSE}
ggplot(effDiv.vessel, aes(x=year, y=mean.earn)) + geom_line(col="red") + 
geom_ribbon(aes(x = year, ymin=mean.earn - sd.earn/mean.earn, 
  ymax = mean.earn + sd.earn/mean.earn), alpha=0.2, fill="red") + 
geom_line(aes(x=year,y=effDiv.person$mean.earn), col="green") + 
geom_ribbon(aes(x = year, ymin=effDiv.person$mean.earn - 
    effDiv.person$sd.earn/effDiv.person$mean.earn, 
  ymax=effDiv.person$mean.earn + effDiv.person$sd.earn/effDiv.person$mean.earn), 
  alpha=0.2, fill="green") + 
ggtitle("Effective species diversity ('specn') [red = vessel, green=person]") + 
xlab("Year") + ylab("Mean (+/- CV)")
```

Now make the portfolio plots from the metafolio package:

```{r, echo=FALSE}
species_diversity_by_year <-
  effectiveDiversity_by_personYear(cfec, variable = "specn")
breaks = c(1, 1.01, 1.5, 2, 2.5, 3, 3.5, 4, 10)
species_diversity <-
  group_by(species_diversity_by_year, p_holder) %>%
  summarize(
    # diversity_by_frequency = mean(eff.freq),
    diversity_by_earnings = mean(eff.earn),
    # diversity_by_weight = mean(eff.lbs),
    m = log10(mean(totIndRev)),
    v = sd(totIndRev) / mean(totIndRev)
  ) %>%
  filter(!is.na(v)) %>%
  mutate(diversity_group = cut(diversity_by_earnings, breaks = breaks,
    right = FALSE))

species_diversity_list <- split(species_diversity,
  species_diversity$diversity_group)

#pdf("earnings_portfolio_by_species_diversity.pdf", height = 5, width = 5)
par(cex = 0.8)
metafolio::plot_cons_plans(
  species_diversity_list,
  plans_name = names(species_diversity_list),
  cols = RColorBrewer::brewer.pal(length(names(species_diversity_list)),
    "YlOrRd"),
  xlab = "CV of gross earnings",
  ylab = "log10 of gross earnings",
  add_all_efs = FALSE)
#dev.off()
```